<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!-- You might want to try something fancier: -->
<!-- html/nunjucks docs: https://mozilla.github.io/nunjucks/ -->
<!-- pug: https://pugjs.org/ -->
<!-- haml: http://haml.info/ -->
<!-- hbs(handlebars): http://handlebarsjs.com/ -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Welcome to Glitch!</title>
    <meta name="description" content="A cool thing made with Glitch">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    <script src="/base64url-arraybuffer.js"></script>
  </head>
  <body>
    <header>
      <h1>
        WebAuthn codelab
      </h1>
    </header>

    <main>
      <h2>
        Welcome, {{username}}!
      </h2>
      <h3>
        Your registered credentials:
      </h3>
      <section>
        <ul id="list">
          
        </ul>
        <button id="register">Register a new credential</button>
      </section>
      <p>
        <a href="/">Try reauth</a>
      </p>
      <p>
        <a href="/auth/signout">Sign out</a>
      </p>
    </main>
    <script type="module">
      import { _fetch, registerCredential, unregisterCredential } from '/client.js';

      const register = document.querySelector('#register');
      register.addEventListener('click', e => {
        registerCredential({
          attestation: 'none',
          authenticatorSelection: {
            authenticatorAttachment: 'platform',
            userVerification: 'required'
          }
        })
        .then(user => {
          if (user) {
            getCredentials();
          } else {
            console.info('Registering credential silently failed.');
          }
        })
        .catch(e => alert(e));
      });

      const removeCredential = e => {
        unregisterCredential(e.target.id)
        .then(() => {
          getCredentials();
        })
        .catch(e => {
          alert(e.error);
        });
      };

      const getCredentials = () => {
        _fetch('/auth/getKeys').then(res => {
          const list = document.querySelector('#list');
          if (res.credentials.length === 0) {
            list.innerHTML = '<li>No credentials found.</li>';
          } else {
            list.innerText = '';
          }
          for (let cred of res.credentials) {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.innerText = cred.credId;
            const div = document.createElement('div');
            div.classList.add('public-key');
            div.innerText = cred.publicKey;
            li.appendChild(span);
            li.appendChild(div);
            const button = document.createElement('button');
            button.innerText = 'Remove';
            button.id = cred.credId;
            button.addEventListener('click', removeCredential);
            li.appendChild(button);
            list.appendChild(li);
          }
        });
      };

      getCredentials();
    </script>
  </body>
</html>
